---
export interface Props {
  enabled?: boolean;
}
const { enabled = false } = Astro.props;
---

{enabled && (
  <script is:inline>
    const LITE_YT_CSS = `
      lite-youtube {
        background-color: #000;
        position: relative;
        display: block;
        contain: content;
        background-position: center center;
        background-size: cover;
        cursor: pointer;
        width: 100%;
        height: 0;
      }
      lite-youtube::before {
        content: attr(data-title);
        display: block;
        position: absolute;
        top: 0;
        background-image: linear-gradient(180deg, rgb(0 0 0 / 67%) 0%, rgb(0 0 0 / 54%) 14%, rgb(0 0 0 / 15%) 54%, rgb(0 0 0 / 5%) 72%, rgb(0 0 0 / 0%) 94%);
        height: 99px;
        width: 100%;
        font-family: "YouTube Noto", Roboto, Arial, Helvetica, sans-serif;
        color: hsl(0deg 0% 93.33%);
        text-shadow: 0 0 2px rgba(0, 0, 0, .5);
        font-size: 18px;
        padding: 25px 20px;
        overflow: hidden;
        white-space: nowrap;
        text-overflow: ellipsis;
        box-sizing: border-box;
      }
      lite-youtube:hover::before {
        color: white;
      }
      lite-youtube::after {
        content: "";
        display: block;
      }
      lite-youtube > iframe {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        border: 0;
      }
      lite-youtube > .lyt-playbtn {
        display: block;
        width: 100%;
        height: 100%;
        background: no-repeat center/68px 48px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 68 48"><path d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55c-2.93.78-4.63 3.26-5.42 6.19C.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z" fill="red"/><path d="M45 24 27 14v20" fill="white"/></svg>');
        position: absolute;
        cursor: pointer;
        z-index: 1;
        filter: grayscale(100%);
        transition: filter .1s cubic-bezier(0, 0, 0.2, 1);
        border: 0;
      }
      lite-youtube:hover > .lyt-playbtn,
      lite-youtube .lyt-playbtn:focus {
        filter: none;
      }
      lite-youtube.lyt-activated {
        cursor: unset;
      }
      lite-youtube.lyt-activated::before,
      lite-youtube.lyt-activated > .lyt-playbtn {
        opacity: 0;
        pointer-events: none;
      }
      .lyt-visually-hidden {
        clip: rect(0 0 0 0);
        clip-path: inset(50%);
        height: 1px;
        overflow: hidden;
        position: absolute;
        white-space: nowrap;
        width: 1px;
      }
    `;

    function injectLiteYTStyles() {
      if (document.querySelector('#lite-yt-styles')) return;
      
      const style = document.createElement('style');
      style.id = 'lite-yt-styles';
      style.textContent = LITE_YT_CSS;
      document.head.appendChild(style);
    }

    class LiteYTEmbed extends HTMLElement {
      connectedCallback() {
        injectLiteYTStyles();
        
        this.videoId = this.getAttribute('videoid');
        let playBtnEl = this.querySelector('.lyt-playbtn,.lty-playbtn');
        this.playLabel = (playBtnEl && playBtnEl.textContent.trim()) || this.getAttribute('playlabel') || 'Play';

        this.dataset.title = this.getAttribute('title') || "";
        this.orientation = this.getAttribute('orientation') || "";
        this.customWidth = this.getAttribute('width');

        if (this.orientation === 'shorts') {
          this.classList.add('shorts-mode');
          const shortsRatio = 9 / 16;
          if (this.customWidth) {
            this.style.paddingBottom = `calc(${this.customWidth} / ${shortsRatio})`;
            this.style.width = this.customWidth;
            this.style.margin = '0 auto';
          } else {
            this.style.paddingBottom = "calc(75% / (9 / 16))";
            this.style.width = '75%';
            this.style.margin = '0 auto';
          }
        } else {
          if (this.hasAttribute('width')) {
            this.style.width = this.customWidth;
            this.style.margin = '0 auto';
            this.style.paddingBottom = `calc(${this.customWidth} / (16 / 9))`;
          } else {
            this.style.paddingBottom = "calc(100% / (16 / 9))";
          }
        }

        if (!this.style.backgroundImage) {
          this.style.backgroundImage = `url("https://i.ytimg.com/vi/${this.videoId}/hqdefault.jpg")`;
          this.upgradePosterImage();
        }

        if (!playBtnEl) {
          playBtnEl = document.createElement('button');
          playBtnEl.type = 'button';
          playBtnEl.classList.add('lyt-playbtn', 'lty-playbtn');
          this.append(playBtnEl);
        }
        if (!playBtnEl.textContent) {
          const playBtnLabelEl = document.createElement('span');
          playBtnLabelEl.className = 'lyt-visually-hidden';
          playBtnLabelEl.textContent = this.playLabel;
          playBtnEl.append(playBtnLabelEl);
        }

        this.addNoscriptIframe();

        if(playBtnEl.nodeName === 'A'){
          playBtnEl.removeAttribute('href');
          playBtnEl.setAttribute('tabindex', '0');
          playBtnEl.setAttribute('role', 'button');
          playBtnEl.addEventListener('keydown', e => {
            if( e.key === 'Enter' || e.key === ' ' ){
              e.preventDefault();
              this.activate();
            }
          });
        }

        this.addEventListener('pointerover', this.constructor.warmConnections, {once: true});
        this.addEventListener('focusin', this.constructor.warmConnections, {once: true});
        this.addEventListener('click', this.activate);
        this.needsYTApi = this.hasAttribute("js-api") || navigator.vendor.includes('Apple') || navigator.userAgent.includes('Mobi');
      }

      upgradePosterImage() {
        setTimeout(() => {
          const webpUrl = `https://i.ytimg.com/vi_webp/${this.videoId}/sddefault.webp`;
          const img = new Image();
          img.fetchPriority = 'low';
          img.referrerpolicy = 'origin';
          img.src = webpUrl;
          img.onload = e => {
            const noAvailablePoster = e.target.naturalHeight == 90 && e.target.naturalWidth == 120;
            if (noAvailablePoster) return;

            this.style.backgroundImage = `url("${webpUrl}")`;
          };
        }, 100);
      }

      static addPrefetch(kind, url, as) {
        const linkEl = document.createElement('link');
        linkEl.rel = kind;
        linkEl.href = url;
        if (as) {
          linkEl.as = as;
        }
        document.head.append(linkEl);
      }

      static warmConnections() {
        if (this.preconnected) return;

        this.addPrefetch('preconnect', 'https://www.youtube-nocookie.com');
        this.addPrefetch('preconnect', 'https://www.google.com');
        this.addPrefetch('preconnect', 'https://googleads.g.doubleclick.net');
        this.addPrefetch('preconnect', 'https://static.doubleclick.net');
        this.preconnected = true;
      }

      addNoscriptIframe() {
        const iframeEl = this.createBasicIframe();
        const noscriptEl = document.createElement('noscript');
        noscriptEl.innerHTML = iframeEl.outerHTML;
        this.append(noscriptEl);
      }

      getParams() {
        const params = new URLSearchParams(this.getAttribute('params') || []);
        params.append('autoplay', '1');
        params.append('playsinline', '1');
        return params;
      }

      async activate(){
        if (this.classList.contains('lyt-activated')) return;
        this.classList.add('lyt-activated');

        if (this.needsYTApi) {
          return this.addYTPlayerIframe(this.getParams());
        }

        const iframeEl = this.createBasicIframe();
        this.append(iframeEl);

        iframeEl.focus();
      }

      createBasicIframe(){
        const iframeEl = document.createElement('iframe');
        iframeEl.width = 560;
        iframeEl.height = 315;
        iframeEl.title = this.playLabel;
        iframeEl.allow = 'accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture';
        iframeEl.allowFullscreen = true;
        iframeEl.referrerPolicy = 'strict-origin-when-cross-origin';
        iframeEl.src = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(this.videoId)}?${this.getParams().toString()}`;
        return iframeEl;
      }

      fetchYTPlayerApi() {
        if (window.YT || (window.YT && window.YT.Player)) return;

        this.ytApiPromise = new Promise((res, rej) => {
          var el = document.createElement('script');
          el.src = 'https://www.youtube.com/iframe_api';
          el.async = true;
          el.onload = _ => {
            YT.ready(res);
          };
          el.onerror = rej;
          this.append(el);
        });
      }

      async addYTPlayerIframe() {
        this.fetchYTPlayerApi();
        await this.ytApiPromise;

        const videoPlaceholderEl = document.createElement('div')
        this.append(videoPlaceholderEl);

        const paramsObj = Object.fromEntries(this.getParams().entries());

        this.playerPromise = new Promise(resolve => {
          let player = new YT.Player(videoPlaceholderEl, {
            width: '100%',
            videoId: this.videoId,
            playerVars: paramsObj,
            events: {
              'onReady': event => {
                event.target.playVideo();
                resolve(player);
              }
            }
          });
        });
      }
    }
    customElements.define('lite-youtube', LiteYTEmbed);
  </script>
)}