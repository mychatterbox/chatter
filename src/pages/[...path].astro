---
import { getCollection, render } from "astro:content";
import Html from "components/html.astro";
import Nav from "components/navbar.astro";
import ReadingProgressBar from "components/ReadingProgressBar.astro";
import type { CollectionEntry } from "astro:content";
import type { ImageMetadata } from "astro";

export async function getStaticPaths() {
  const blogPosts = await getCollection("blog");

  let draftPosts: CollectionEntry<"draft">[] = [];
  
  if (import.meta.env.DEV) {
    try {
      draftPosts = await getCollection("draft");
    } catch (error) {
      console.warn("Draft collection is empty or does not exist");
    }
  }

  return [...blogPosts, ...draftPosts].map((entry) => ({
    params: { path: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

const { title, description, pubDate, kind, tags, ogImage } = entry.data;
const tagLinks = tags?.map((tag) => ({ tag, url: `/tag/${tag}` })) ?? [];
const isDraft = entry.collection === "draft";

let processedOgImage: string | undefined;

if (ogImage) {
  if (ogImage.startsWith('http://') || ogImage.startsWith('https://')) {
    processedOgImage = ogImage;
  } else if (ogImage.startsWith('/')) {
    processedOgImage = ogImage;
  } else if (ogImage.startsWith('./') || ogImage.startsWith('../')) {
    try {
      const images = import.meta.glob<{ default: ImageMetadata }>(
        '/src/content/blog/blog-images/**/*.{png,jpg,jpeg,webp,avif}',
        { eager: true }
      );
      
      const imagePath = ogImage.replace('./', '/src/content/blog/');
      const imageModule = images[imagePath];
      
      if (imageModule?.default) {
        processedOgImage = imageModule.default.src;
      } else {
        console.warn(`OG image not found: ${ogImage}`);
      }
    } catch (e) {
      console.warn(`Failed to load OG image: ${ogImage}`, e);
    }
  }
}
---

<Html
  title={title}
  description={description}
  pubDate={pubDate}
  ogType="article"
  ogImage={processedOgImage}
>
  <ReadingProgressBar/>
  <Nav />

  <main class="main-container">
    <article class="article-container">
      <div class="article-header">
        <h1 class="title-xl" transition:name={`title-${entry.id}`}>
          {title}
        </h1>

    <div class="article-meta text-small text-muted flex-wrap">
      {kind === "article" && (
        <a href="/kind/article" class="link-article">Article</a>
      )}
      {kind === "note" && (
        <a href="/kind/note" class="link-note">Note</a>
      )}

      <div>{pubDate.toISOString().slice(0, 10)}</div>

      {isDraft && <div class="text-draft">_____ Draft _____</div>}
    </div>
      </div>

      <Content />

      {tagLinks.length > 0 && (
        <div class="tags-container">
          <div class="tags-wrapper">
            {tagLinks.map(({ tag, url }) => (
              <a href={url} class="link-tag">
                <span class="tag-hash">#</span>{tag}
              </a>
            ))}
          </div>
        </div>
      )}
    </article>
  </main>
</Html>