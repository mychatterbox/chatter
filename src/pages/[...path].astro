---
import { getCollection, render } from "astro:content";
import Html from "components/html.astro";
import Nav from "components/navbar.astro";
import ReadingProgressBar from "components/ReadingProgressBar.astro";
import type { CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const blogPosts = await getCollection("blog");

  let draftPosts: CollectionEntry<"draft">[] = [];
  
  if (import.meta.env.DEV) {
    try {
      draftPosts = await getCollection("draft");
    } catch (error) {
      console.warn("Draft collection is empty or does not exist");
    }
  }

  return [...blogPosts, ...draftPosts].map((entry) => ({
    params: { path: entry.id },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await render(entry);

const { title, description, pubDate, kind, tags } = entry.data;
const tagLinks = tags?.map((tag) => ({ tag, url: `/tag/${tag}` })) ?? [];
---

<Html
  title={title}
  description={description}
  pubDate={pubDate}
  ogType="article"
>
  <ReadingProgressBar/>
  <Nav />

  <main class="main-container">
    <article class="article-container">
      <div class="article-header">
        <h1 class="title-xl" transition:name={`title-${entry.id}`}>
          {title}
        </h1>

        <div class="article-meta text-small text-muted">
          {kind === "article" && <a href="/kind/article" class="link-article pr-2">Article</a>}
          {kind === "note" && <a href="/kind/note" class="link-note pr-2">Note</a>}
          <span>{pubDate.toISOString().slice(0, 10)}</span>

          {entry.collection === "draft" && (
            <span class="text-draft">Draft</span>
          )}
        </div>
      </div>

      <Content />

      {tagLinks.length > 0 && (
        <div class="tags-container">
          <div class="tags-wrapper">
            {tagLinks.map(({ tag, url }) => (
              <a href={url} class="link-tag">
                <span class="tag-hash">#</span>{tag}
              </a>
            ))}
          </div>
        </div>
      )}
    </article>
  </main>
</Html>