---
import { getCollection, render } from "astro:content";
import Html from "components/layout/html.astro";
import Nav from "components/layout/navbar.astro";
import ReadingProgressBar from "components/features/ReadingProgressBar.astro";
import Pagination from "components/features/Pagination.astro";
import FeedItem from "components/content/feed-item.astro";
import type { CollectionEntry } from "astro:content";
import { processOgImage } from "../utils/og-image";
import { PAGE_SIZE } from "config/pagination";
import ImageModal from "components/features/ImageModal.astro";

import LiteYTScript from "utils/lite-yt-embed.astro";

export async function getStaticPaths() {
  const blogPosts = await getCollection("blog");
  let draftPosts: CollectionEntry<"draft">[] = [];

  if (import.meta.env.DEV) {
    try {
      draftPosts = await getCollection("draft");
    } catch (error) {
      console.warn("Draft collection is empty or does not exist");
    }
  }

  const allPosts = [...blogPosts, ...draftPosts].sort(
    (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime(),
  );

  const postPaths = allPosts.map((entry) => ({
    params: { path: entry.id },
    props: { entry, type: "post" as const },
  }));

  const totalPages = Math.ceil(allPosts.length / PAGE_SIZE);
  const paginationPaths = [];

  for (let i = 2; i <= totalPages; i++) {
    const start = (i - 1) * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const pagePosts = allPosts.slice(start, end);

    paginationPaths.push({
      params: { path: i.toString() },
      props: {
        type: "page" as const,
        posts: pagePosts,
        currentPage: i,
        totalPages,
      },
    });
  }

  return [...postPaths, ...paginationPaths];
}

// 2. Astro.props에서 필요한 값들을 한 번에 가져오기
const { entry, type, posts, currentPage, totalPages } = Astro.props;

// 3. 포스트인 경우 콘텐츠 렌더링 및 유튜브 체크
const renderResult = entry ? await render(entry) : { Content: null };
// @ts-ignore
const { Content } = renderResult;

// 프론트메터에 youtube: true가 있는지 확인
const hasYoutube = type === "post" && entry?.data?.youtube === true;

// 공통 변수 초기화
let title = "";
let description = "";
let pubDate;
let kind;
let isDraft = false;
let processedOgImage;
let tagLinks: { tag: string; url: string }[] = [];

if (type === "post" && entry) {
  const data = entry.data;
  title = data.title;
  description = data.description;
  pubDate = data.pubDate;
  kind = data.kind;
  isDraft = entry.collection === "draft";
  processedOgImage = await processOgImage(data.ogImage);
  tagLinks =
    data.tags?.map((tag) => ({
      tag,
      url: `/tag/${encodeURIComponent(tag)}`,
    })) ?? [];
} else {
  title = `Page ${currentPage}`;
  description = "Archived posts";
}
---

{
  type === "post" && entry ? (
    <Html
      title={title}
      description={description}
      pubDate={pubDate}
      ogType="article"
      ogImage={processedOgImage}
    >
      <ReadingProgressBar />
      <Nav />
      <ImageModal />
{hasYoutube && <LiteYTScript enabled={hasYoutube} />}

      <main class="main-container">
        <article class="article-container" data-pagefind-body>
          <div class="article-header">
            <h1 class="title-post" transition:name={`title-${entry?.id}`}>
              {title}
            </h1>

            <div class="article-meta text-small text-muted flex-wrap">
              {kind === "article" && (
                <a href="/kind/article" class="link-article">
                  Article
                </a>
              )}
              {kind === "note" && (
                <a href="/kind/note" class="link-note">
                  Note
                </a>
              )}

              <div>{pubDate?.toISOString().slice(0, 10)}</div>

              {isDraft && <div class="text-draft">_____ Draft _____</div>}
            </div>
          </div>
          <div class="article-body">
            {Content ? (
              <Content />
            ) : (
              <div class="error-message">Error loading content</div>
            )}
          </div>
          {tagLinks.length > 0 && (
            <div class="article-footer">
              <div class="tags-wrapper">
                {tagLinks.map(({ tag, url }) => (
                  <a href={url} class="link-tag">
                    <span class="tag-hash">#</span>
                    {tag}
                  </a>
                ))}
              </div>
            </div>
          )}
        </article>
      </main>
    </Html>
  ) : (
    <Html title="mychatterbox" description="이런 것도 팁이 되나 싶은 정보들">
      <Nav />
      <main class="main-container">
        <div class="landing-content">
          <ul class="feed-list">
            {posts.map((post) => (
              <FeedItem entry={post} />
            ))}
          </ul>

          <Pagination
            currentPage={currentPage}
            totalPages={totalPages}
            baseUrl="/"
          />
        </div>
      </main>
    </Html>
  )
}