---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import FeedItem from "components/feed-item.astro";
import TagsSidebar from "components/sidebar-tags.astro";
import Html from "components/html.astro";
import Nav from "components/navbar.astro";

const blogPosts = await getCollection("blog");

let draftPosts: CollectionEntry<"draft">[] = [];
if (import.meta.env.DEV) {
  try {
    draftPosts = await getCollection("draft");
  } catch {
    console.warn("Draft collection is empty or does not exist");
  }
}

const posts = [...blogPosts, ...draftPosts];
posts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());

// 태그별 포스트 수 계산 (타입 안전)
const tagCounts: Record<string, number> = {};
posts.forEach((entry) => {
  entry.data.tags?.forEach((tag: string) => {
    tagCounts[tag] = (tagCounts[tag] ?? 0) + 1;
  });
});

// 포스트 수 기준으로 정렬
const sortedTags = Object.keys(tagCounts).sort(
  (a, b) => tagCounts[b] - tagCounts[a] || a.localeCompare(b)
);
---

<Html title="mychatterbox" description="이런 것도 팁이 되나 싶은 정보들">
  <Nav />

  <main class="main-container">
    <div class="landing-content">
      <ul class="feed-list">
        {posts.map((entry) => (<FeedItem entry={entry} />))}
      </ul>

      <!-- Tags Sidebar -->
      <TagsSidebar tags={sortedTags} counts={tagCounts} />
    </div>
  </main>
</Html>

<style>
/* Landing Content Layout */
.landing-content {
  display: block;
  gap: var(--spacing-8);
  margin: 0 auto;
}

@media (min-width: 1025px) {
  .landing-content {
    display: grid;
    grid-template-columns: 1fr 200px;
    max-width: 968px;
    align-items: flex-start;
  }
}

</style>
