---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import FeedItem from "components/content/feed-item.astro";
import Html from "components/layout/html.astro";
import Nav from "components/layout/navbar.astro";
import Pagination from "components/ui/Pagination.astro";
import { PAGE_SIZE } from "config/pagination";

export async function getStaticPaths() {
  const blogPosts = await getCollection("blog");
  
  let draftPosts: CollectionEntry<"draft">[] = [];
  if (import.meta.env.DEV) {
    try {
      draftPosts = await getCollection("draft");
    } catch (error) {
      console.warn("Draft collection is empty or does not exist");
    }
  }
  
  const allPosts = [...blogPosts, ...draftPosts];
  const tagsSet = new Set<string>();
  
  allPosts.forEach((entry) => {
    if (entry.data.tags) {
      entry.data.tags.forEach((tag: string) => tagsSet.add(tag));
    }
  });
  
  const paths = [];

  for (const tag of tagsSet) {
    const filteredPosts = allPosts.filter((p) => p.data.tags?.includes(tag));
    filteredPosts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
    
    const totalPages = Math.ceil(filteredPosts.length / PAGE_SIZE);
    
    if (totalPages === 0) continue;

    for (let i = 1; i <= totalPages; i++) {
        const start = (i - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        const pagePosts = filteredPosts.slice(start, end);

        paths.push({
            params: { tag, page: i.toString() },
            props: { 
                posts: pagePosts, 
                currentPage: i, 
                totalPages,
                tag 
            }
        });
    }
  }
  
  return paths;
}

const { posts, currentPage, totalPages, tag } = Astro.props;

const title = `#${tag}`;
const description = `${tag} 태그가 달린 게시물`;
---

<Html title={title} description={description}>
  <Nav />
  <main class="main-container">
      <div class="article-container pt-4 text-big">
        <span class="tag-hash">#</span>{tag}
        <hr/>
      </div>

    <ul class="feed-list article-container">
      {posts.map((entry) => <FeedItem entry={entry} />)}
    </ul>
    
    <Pagination 
      currentPage={currentPage}
      totalPages={totalPages}
      baseUrl={`/tag/${tag}`}
    />
  </main>
</Html>
