---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import FeedItem from "components/content/feed-item.astro";
import Html from "components/layout/html.astro";
import Nav from "components/layout/navbar.astro";
import Pagination from "components/ui/Pagination.astro";
import { PAGE_SIZE } from "config/pagination";

export async function getStaticPaths() {
    const blogPosts = await getCollection("blog");

    let draftPosts: CollectionEntry<"draft">[] = [];
    if (import.meta.env.DEV) {
        try {
            draftPosts = await getCollection("draft");
        } catch (error) {
            console.warn("Draft collection is empty or does not exist");
        }
    }

    const allPosts = [...blogPosts, ...draftPosts];
    const tagsSet = new Set<string>();

    allPosts.forEach((entry) => {
        if (entry.data.tags) {
            entry.data.tags.forEach((tag: string) => tagsSet.add(tag));
        }
    });

    const paths = [];

    for (const tag of tagsSet) {
        const filteredPosts = allPosts.filter((p) =>
            p.data.tags?.includes(tag),
        );
        filteredPosts.sort(
            (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime(),
        );

        const totalPages = Math.ceil(filteredPosts.length / PAGE_SIZE);
        if (totalPages === 0) continue;

        const page1Posts = filteredPosts.slice(0, PAGE_SIZE);

        // 1. Root tag path (Render Page 1 directly)
        paths.push({
            params: { path: tag },
            props: {
                posts: page1Posts,
                currentPage: 1,
                totalPages,
                tag,
                isRedirect: false,
            },
        });

        // 2. Explicit Page 1 path (Redirect to Root)
        paths.push({
            params: { path: `${tag}/1` },
            props: { tag, isRedirect: true },
        });

        // 3. Page 2+
        for (let i = 2; i <= totalPages; i++) {
            const start = (i - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pagePosts = filteredPosts.slice(start, end);

            paths.push({
                params: { path: `${tag}/${i}` },
                props: {
                    posts: pagePosts,
                    currentPage: i,
                    totalPages,
                    tag,
                    isRedirect: false,
                },
            });
        }
    }

    return paths;
}

const { posts, currentPage, totalPages, tag, isRedirect } = Astro.props;

if (isRedirect) {
    return Astro.redirect(`/tag/${encodeURIComponent(tag)}`);
}

const title = `#${tag}`;
const description = `${tag} 태그가 달린 게시물`;
---

<Html title={title} description={description}>
    <Nav />
    <main class="main-container">
        <h1 class="tags-header pt-4">
            <span class="tag-hash">#</span>{tag}
            <hr />
        </h1>

        <ul class="feed-list">
            {posts && posts.map((entry) => <FeedItem entry={entry} />)}
        </ul>

        {
            totalPages && (
                <Pagination
                    currentPage={currentPage}
                    totalPages={totalPages}
                    baseUrl={`/tag/${tag}`}
                />
            )
        }
    </main>
</Html>
