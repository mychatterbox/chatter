---
import Html from "components/layout/html.astro";
import Nav from "components/layout/navbar.astro";
---

<Html title="Search" description="Search the blog">
  <Nav />
  <main class="main-container">
    <div class="search-wrapper mt-12">
      <h1>블로그 검색</h1>
      <div id="search"></div>
    </div>
  </main>
</Html>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet" />

<script is:inline>
  function initPagefind() {
    const searchDiv = document.getElementById("search");
    if (!searchDiv) return;

    searchDiv.innerHTML = "";

    const scriptSrc = "/pagefind/pagefind-ui.js";

    // 공통 PagefindUI 설정
    const pagefindConfig = {
      element: "#search",
      showSubResults: true,
      showImages: false,
      pageSize: 20,
      translations: {
        placeholder: "검색어를 입력하세요...",
        zero_results: "[SEARCH_TERM]에 대한 결과가 없습니다.",
        one_result: "관련글 : [COUNT] 건",
        many_results: "관련글 : [COUNT] 건",
        clear_search: "clear",
      },
      processResult: function (result) {
        result.url = result.url.replace(".html", "");
        if (result.sub_results) {
          result.sub_results.forEach((sub) => {
            sub.url = sub.url.replace(".html", "");
          });
        }
        return result;
      },
    };

    // 공통 input 핸들러 설정
    function setupInputHandler() {
      setTimeout(() => {
        const input = searchDiv.querySelector("input");
        if (input) {
          input.focus();

          const urlParams = new URLSearchParams(window.location.search);
          const query = urlParams.get("q");
          if (query) {
            input.value = query;
            input.dispatchEvent(new Event("input", { bubbles: true }));
          }

          input.addEventListener("input", (e) => {
            const term = e.target.value;
            const url = new URL(window.location);
            if (term) {
              url.searchParams.set("q", term);
            } else {
              url.searchParams.delete("q");
            }
            history.replaceState(history.state, "", url);
          });
        }
      }, 100);
    }

    // PagefindUI 초기화
    if (typeof PagefindUI !== "undefined") {
      new PagefindUI(pagefindConfig);
      setupInputHandler();
    } else {
      const script = document.createElement("script");
      script.src = scriptSrc;
      script.onload = () => {
        new PagefindUI(pagefindConfig);
        setupInputHandler();
      };
      document.head.appendChild(script);
    }
  }

  window.addEventListener("DOMContentLoaded", initPagefind);

  document.addEventListener("astro:page-load", initPagefind);
</script>

<style is:global>
  #search {
    --pagefind-ui-scale: 1;
    --pagefind-ui-text: var(--color-text-primary);
    --pagefind-ui-background: var(--color-bg);
    --pagefind-ui-border: var(--color-border);
    --pagefind-ui-tag: var(--color-border);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 4px;
    --pagefind-ui-image-border-radius: 4px;
    --pagefind-ui-image-box-ratio: 3 / 2;
    --pagefind-ui-font: var(--font-sans);

    .pagefind-ui__message {
      font-weight: 400;
    }

    input {
      font-weight: 500;
    }

    .pagefind-ui__search-clear {
      background-color: transparent;
      font-size: 0.92rem;
    }

    .pagefind-ui__results .pagefind-ui__result {
      padding-bottom: var(--spacing-8);
      padding-top: var(--spacing-4);
      text-underline-offset: 4px;
      text-decoration-thickness: 2px;
    }

    .pagefind-ui__result-link {
      font-size: 1.16rem;
    }

    @media (min-width: 768px) {
      .pagefind-ui__result-link {
        font-size: 1.24rem;
      }
    }

    .pagefind-ui__result-excerpt {
    }

    .pagefind-ui mark {
      background-color: transparent;
      color: var(--mark-text-color);
      font-weight: 500;
    }
  }
</style>
