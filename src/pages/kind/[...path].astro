---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import FeedItem from "components/content/feed-item.astro";
import Html from "components/layout/html.astro";
import Nav from "components/layout/navbar.astro";
import Pagination from "components/ui/Pagination.astro";
import { PAGE_SIZE } from "config/pagination";

export async function getStaticPaths() {
    const blogPosts = await getCollection("blog");

    let draftPosts: CollectionEntry<"draft">[] = [];
    if (import.meta.env.DEV) {
        try {
            draftPosts = await getCollection("draft");
        } catch (error) {
            console.warn("Draft collection is empty or does not exist");
        }
    }

    const allPosts = [...blogPosts, ...draftPosts];
    const kinds = new Set(allPosts.map((entry) => entry.data.kind));

    const paths = [];

    for (const kind of kinds) {
        const filteredPosts = allPosts.filter((p) => p.data.kind === kind);
        filteredPosts.sort(
            (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime(),
        );

        const totalPages = Math.ceil(filteredPosts.length / PAGE_SIZE);

        if (totalPages === 0) continue;

        const page1Posts = filteredPosts.slice(0, PAGE_SIZE);

        // 1. Root kind path (Render Page 1 directly)
        paths.push({
            params: { path: kind },
            props: {
                posts: page1Posts,
                currentPage: 1,
                totalPages,
                kind,
                isRedirect: false,
            },
        });

        // 2. Explicit Page 1 path (Redirect to Root)
        paths.push({
            params: { path: `${kind}/1` },
            props: { kind, isRedirect: true },
        });

        // 3. Page 2+
        for (let i = 2; i <= totalPages; i++) {
            const start = (i - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pagePosts = filteredPosts.slice(start, end);

            paths.push({
                params: { path: `${kind}/${i}` },
                props: {
                    posts: pagePosts,
                    currentPage: i,
                    totalPages,
                    kind,
                    isRedirect: false,
                },
            });
        }
    }

    return paths;
}

const { posts, currentPage, totalPages, kind, isRedirect } = Astro.props;

if (isRedirect) {
    return Astro.redirect(`/kind/${kind}`);
}

const title = `Kind: ${kind}`;
---

<Html title={title} description="이런 것도 팁이 되나 싶은 정보들">
    <Nav />
    <main class="main-container">
        <h1 class="kind-header">
            Kind: {kind}
            <hr />
        </h1>

        <ul class="feed-list">
            {posts && posts.map((entry) => <FeedItem entry={entry} />)}
        </ul>

        {
            totalPages && (
                <Pagination
                    currentPage={currentPage}
                    totalPages={totalPages}
                    baseUrl={`/kind/${kind}`}
                />
            )
        }
    </main>
</Html>
