---
import "../../styles/font-change-preview.css";
import FontSizeIcon from "../../icons/hero/solid/FontSizeIcon.svg";
const defaultSize = 16;
const fontSizes = [14, 15, 16, 17, 18];
---

<div class="fontchange-container" id="fontchange-wrapper">
  <button
    type="button"
    class="fontchange-btn"
    id="fontchange-btn"
    aria-label="글꼴 크기 변경"
    aria-haspopup="dialog"
    aria-controls="fontchange-popover"
    aria-expanded="false"
  >
    <FontSizeIcon class="fontchange-icon" aria-hidden="true" />
  </button>

  <div
    class="fontchange-popover"
    id="fontchange-popover"
    role="dialog"
    aria-modal="false"
    aria-hidden="true"
    style="display: none;"
  >
    <input
      type="range"
      id="fontchange-slider"
      class="fontchange-slider"
      min="14"
      max="18"
      step="1"
      value={String(defaultSize)}
      aria-label="글꼴 크기 조절"
      aria-valuemin="14"
      aria-valuemax="18"
      aria-valuenow={String(defaultSize)}
    />
    
    <div class="fontchange-slider-labels" role="list">
      {fontSizes.map((size) => (
        <span
          class="fontchange-label"
          data-size={String(size)}
          role="listitem"
          tabindex="0"
          aria-label={`${size} 픽셀`}
        >
          {size}
        </span>
      ))}
    </div>
    
    <div class="fontchange-preview">
      <span class="fontchange-preview-text" id="fontchange-preview-text" style={`font-size: ${defaultSize}px`}>
        가나다 Abc
      </span>
      <span class="fontchange-preview-size" id="fontchange-preview-size">
        {String(defaultSize)}px
      </span>
    </div>
  </div>
</div>

<script lang="js">
  (function () {
    if (typeof window === 'undefined') return;
    const ROOT_SELECTOR = '#fontchange-wrapper';

    function updatePopoverPosition(popover) {
      const isMobile = window.innerWidth < 640;
      if (isMobile) {
        popover.style.top = 'auto';
        popover.style.bottom = '0';
      } else {
        popover.style.top = '100%';
        popover.style.bottom = 'auto';
      }
    }

    function initFontChange() {
      const root = document.querySelector(ROOT_SELECTOR);
      if (!root || root.__fontChangeInitialized) return;
      root.__fontChangeInitialized = true;

      const btn = root.querySelector('#fontchange-btn');
      const popover = root.querySelector('#fontchange-popover');
      const slider = root.querySelector('#fontchange-slider');
      const previewText = root.querySelector('#fontchange-preview-text');
      const previewSize = root.querySelector('#fontchange-preview-size');
      const labels = Array.from(root.querySelectorAll('.fontchange-label'));

      // 로컬 스토리지에서 값 불러오기
      const DEFAULT = 16;
      let savedSize = DEFAULT;
      try {
        savedSize = Number(localStorage.getItem('fontSize')) || DEFAULT;
      } catch (e) { savedSize = DEFAULT; }

      // 초기 UI 세팅
      const updateUI = (size) => {
        slider.value = String(size);
        if (previewText) previewText.style.fontSize = `${size}px`;
        if (previewSize) previewSize.textContent = `${size}px`;
        labels.forEach(l => l.classList.toggle('active', l.dataset.size === String(size)));
        document.documentElement.style.setProperty('--base-font-size', `${size}px`);
      };
      updateUI(savedSize);

      let closeTimeout = null;

      // ESC 키 핸들러
      const handleEscapeKey = (e) => {
        if (e.key === 'Escape' || e.key === 'Esc') {
          e.preventDefault();
          closePopover();
          // ESC 키로 닫힐 때 버튼으로 포커스 이동
          if (btn && typeof btn.focus === 'function') {
            btn.focus({ preventScroll: true });
          }
        }
      };

      const openPopover = () => {
        updatePopoverPosition(popover);
        popover.style.display = 'block';
        
        // 브라우저가 display: block을 먼저 렌더링하도록 강제 리플로우
        void popover.offsetWidth; 

        requestAnimationFrame(() => {
          popover.classList.add('visible');
          popover.setAttribute('aria-hidden', 'false');
          btn.setAttribute('aria-expanded', 'true');
          // 팝업 열릴 때 슬라이더에 포커스
          slider?.focus({ preventScroll: true });
        });

        document.addEventListener('click', onDocumentClick);
        window.addEventListener('resize', onResize);
        // ESC 키 리스너 추가
        document.addEventListener('keydown', handleEscapeKey);
      };

      const closePopover = () => {
        popover.classList.remove('visible');
        popover.setAttribute('aria-hidden', 'true');
        btn.setAttribute('aria-expanded', 'false');

        clearTimeout(closeTimeout);
        // 애니메이션(0.3s)이 끝난 후 display none 처리
        closeTimeout = setTimeout(() => {
          if (!popover.classList.contains('visible')) {
            popover.style.display = 'none';
          }
        }, 300);

        // 모든 이벤트 리스너 제거
        document.removeEventListener('click', onDocumentClick);
        window.removeEventListener('resize', onResize);
        document.removeEventListener('keydown', handleEscapeKey);
      };

      const onToggle = (e) => {
        e.stopPropagation();
        popover.classList.contains('visible') ? closePopover() : openPopover();
      };

      const onDocumentClick = (e) => {
        if (!root.contains(e.target)) closePopover();
      };

      const onResize = () => {
        updatePopoverPosition(popover);
      };

      // 이벤트 등록
      btn.addEventListener('click', onToggle);
      
      slider.addEventListener('input', (e) => {
        const size = e.target.value;
        updateUI(size);
      });

      slider.addEventListener('change', (e) => {
        localStorage.setItem('fontSize', e.target.value);
      });

      labels.forEach(l => {
        l.addEventListener('click', () => {
          const size = l.dataset.size;
          updateUI(size);
          localStorage.setItem('fontSize', size);
        });
        
        // 레이블에서도 ESC 키 동작 (선택사항)
        l.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' || e.key === 'Esc') {
            e.preventDefault();
            closePopover();
            btn?.focus({ preventScroll: true });
          }
        });
      });

      // Astro Cleanup 로직
      root.__fontChangeCleanup = () => {
        btn.removeEventListener('click', onToggle);
        document.removeEventListener('click', onDocumentClick);
        window.removeEventListener('resize', onResize);
        document.removeEventListener('keydown', handleEscapeKey);
        root.__fontChangeInitialized = false;
      };
    }

    initFontChange();
    document.addEventListener('astro:page-load', initFontChange);
  })();
</script>