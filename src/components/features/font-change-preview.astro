---
import "../../styles/font-change-preview.css";
import FontSizeIcon from "../../icons/hero/solid/FontSizeIcon.svg";

const FONT_SIZE_START = 14;
const FONT_SIZE_END = 20;
const FONT_SIZE_STEP = 1;
const DEFAULT_FONT_SIZE = 16;

const fontSizes = Array.from(
  { length: ((FONT_SIZE_END - FONT_SIZE_START) / FONT_SIZE_STEP) + 1 },
  (_, i) => FONT_SIZE_START + i * FONT_SIZE_STEP
);
---

<div class="fontchange-container" id="fontchange-wrapper">
  <button
    type="button"
    class="fontchange-btn"
    id="fontchange-btn"
    aria-label="글꼴 크기 변경"
    aria-haspopup="dialog"
    aria-controls="fontchange-popover"
    aria-expanded="false"
  >
    <FontSizeIcon class="fontchange-icon" aria-hidden="true" />
  </button>

  <div
    class="fontchange-popover"
    id="fontchange-popover"
    role="dialog"
    aria-modal="false"
    aria-hidden="true"
    style="display: none;"
  >
    <!-- Slider -->
    <div class="fontchange-slider-container">
      <input
        type="range"
        id="fontchange-slider"
        class="fontchange-slider"
        min={FONT_SIZE_START}
        max={FONT_SIZE_END}
        step={FONT_SIZE_STEP}
        value={String(DEFAULT_FONT_SIZE)}
        aria-label="글꼴 크기 조절"
      />
    </div>

    <!-- Labels -->
    <div class="fontchange-slider-labels" role="list">
      {fontSizes.map((size) => (
        <span
          class="fontchange-label"
          data-size={String(size)}
          role="listitem"
          tabindex="0"
          aria-label={`${size}px`}
        >
          {size}
        </span>
      ))}
    </div>

    <!-- Preview -->
    <div class="fontchange-preview">
      <span
        class="fontchange-preview-text"
        id="fontchange-preview-text"
        style={`font-size: ${DEFAULT_FONT_SIZE}px`}
      >
        가나다 Abc
      </span>
      <span
        class="fontchange-preview-size"
        id="fontchange-preview-size"
      >
        {String(DEFAULT_FONT_SIZE)}px
      </span>
    </div>
  </div>
</div>

<script lang="js">
(function () {
  if (typeof window === 'undefined') return;

  const ROOT_SELECTOR = '#fontchange-wrapper';

  function initFontChange() {
    const root = document.querySelector(ROOT_SELECTOR);
    if (!root || root.__fontChangeInitialized) return;
    root.__fontChangeInitialized = true;
    const DEFAULT = Number(root.dataset.defaultFontSize) || 16;

    const btn = root.querySelector('#fontchange-btn');
    const popover = root.querySelector('#fontchange-popover');
    const slider = root.querySelector('#fontchange-slider');
    const previewText = root.querySelector('#fontchange-preview-text');
    const previewSize = root.querySelector('#fontchange-preview-size');
    const labels = Array.from(root.querySelectorAll('.fontchange-label'));



    /* =========================
       LocalStorage
    ========================= */
    const storage = {
      get() {
        try {
          return Number(localStorage.getItem('fontSize')) || DEFAULT;
        } catch {
          return DEFAULT;
        }
      },
      set(value) {
        try {
          localStorage.setItem('fontSize', value);
        } catch {}
      }
    };

    /* =========================
       Popover width 자동 계산
    ========================= */
    const updatePopoverWidth = () => {
      const LABEL_MIN_WIDTH = 42;
      const GAP = 1;
      const SIDE_PADDING = 32;

      const count = labels.length;
      const width =
        count * LABEL_MIN_WIDTH +
        (count - 1) * GAP +
        SIDE_PADDING;

      popover.style.setProperty(
        '--fontchange-popover-width',
        `${Math.max(width, 280)}px`
      );
    };

    /* =========================
       UI 업데이트
    ========================= */
    const updateUI = (size) => {
      slider.value = String(size);

      previewText.style.fontSize = `${size}px`;
      previewSize.textContent = `${size}px`;
      previewSize.style.fontSize = `${size}px`;

      labels.forEach(label =>
        label.classList.toggle(
          'active',
          label.dataset.size === String(size)
        )
      );

      document.documentElement.style.setProperty(
        '--base-font-size',
        `${size}px`
      );
    };

    /* =========================
       초기화
    ========================= */
    const savedSize = storage.get();
    updatePopoverWidth();
    updateUI(savedSize);

    /* =========================
       Popover 제어
    ========================= */
    let closeTimeout = null;

    const handleEscapeKey = (e) => {
      if (e.key === 'Escape') {
        closePopover();
        btn.focus({ preventScroll: true });
      }
    };

    const openPopover = () => {
      popover.style.display = 'block';
      void popover.offsetWidth;

      requestAnimationFrame(() => {
        popover.classList.add('visible');
        popover.setAttribute('aria-hidden', 'false');
        btn.setAttribute('aria-expanded', 'true');
        slider.focus({ preventScroll: true });
      });

      document.addEventListener('click', onDocumentClick);
      document.addEventListener('keydown', handleEscapeKey);
    };

    const closePopover = () => {
      popover.classList.remove('visible');
      popover.setAttribute('aria-hidden', 'true');
      btn.setAttribute('aria-expanded', 'false');

      clearTimeout(closeTimeout);
      closeTimeout = setTimeout(() => {
        if (!popover.classList.contains('visible')) {
          popover.style.display = 'none';
        }
      }, 300);

      document.removeEventListener('click', onDocumentClick);
      document.removeEventListener('keydown', handleEscapeKey);
    };

    const onToggle = (e) => {
      e.stopPropagation();
      popover.classList.contains('visible')
        ? closePopover()
        : openPopover();
    };

    const onDocumentClick = (e) => {
      if (!root.contains(e.target)) closePopover();
    };

    /* =========================
       이벤트
    ========================= */
    btn.addEventListener('click', onToggle);

    slider.addEventListener('input', (e) => {
      updateUI(e.target.value);
    });

    slider.addEventListener('change', (e) => {
      storage.set(e.target.value);
    });

    labels.forEach(label => {
      label.addEventListener('click', () => {
        const size = label.dataset.size;
        updateUI(size);
        storage.set(size);
      });
    });

    root.__fontChangeCleanup = () => {
      btn.removeEventListener('click', onToggle);
      document.removeEventListener('click', onDocumentClick);
      document.removeEventListener('keydown', handleEscapeKey);
      root.__fontChangeInitialized = false;
    };
  }

  initFontChange();
  document.addEventListener('astro:page-load', initFontChange);
})();
</script>
