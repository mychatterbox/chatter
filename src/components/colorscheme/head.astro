---
const colors = {
  dark: "#111111",
  light: "#eeeeee",
};
---

<script
  is:inline
  define:vars={{
    lightTheme: colors.light,
    darkTheme: colors.dark
  }}
>
requestAnimationFrame(() => {
  if (window.__themeInitialized) return;
  window.__themeInitialized = true;

  // meta theme-color
  let metaTheme = document.querySelector('meta[name="theme-color"]');
  if (!metaTheme) {
    metaTheme = document.createElement('meta');
    metaTheme.name = 'theme-color';
    document.head.appendChild(metaTheme);
  }

  const applyTheme = (mode, doc = document) => {
    const currentMetaTheme = doc.querySelector('meta[name="theme-color"]');

    if (mode === 'dark') {
      doc.documentElement.classList.add('dark');
      currentMetaTheme.content = darkTheme;
    } else if (mode === 'light') {
      doc.documentElement.classList.remove('dark');
      currentMetaTheme.content = lightTheme;
    } else {
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      doc.documentElement.classList.toggle('dark', prefersDark);
      currentMetaTheme.removeAttribute('content');
    }

    // 로컬 페이지에서만 저장
    if (doc === document) localStorage.setItem('theme', mode);

    // 테마 변경 알림 이벤트 (토글은 이걸 구독)
    window.dispatchEvent(new CustomEvent('themechange', { detail: { mode } }));
  };

  const getTheme = () => {
    const saved = localStorage.getItem('theme');
    return saved ? saved : 'device';
  };

  // 초기 적용
  applyTheme(getTheme());

  // 페이지 전환 전: 새 문서에 테마 적용
  document.addEventListener('astro:before-swap', ({ newDocument }) => {
    if (!newDocument.querySelector('meta[name="theme-color"]')) {
      const newMetaTheme = newDocument.createElement('meta');
      newMetaTheme.name = 'theme-color';
      newDocument.head.appendChild(newMetaTheme);
    }
    applyTheme(getTheme(), newDocument);
  });

  // setTheme API
  window.setTheme = (mode) => {
    applyTheme(mode);
    return mode;
  };

  // 시스템 다크모드 변경 감지 (device 모드일 때)
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
    if (localStorage.getItem('theme') === 'device') {
      applyTheme('device');
    }
  });
});
</script>